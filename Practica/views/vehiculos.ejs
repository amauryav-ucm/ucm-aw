<h1 class="text-center">Vehículos Disponibles</h1>

<div class="container-fluid">
    
    <div class="row mt-3 align-items-start">

        <div class="col-md-3 mb-4">
            <div class="p-3 border rounded shadow-sm">
                <h5 class="mb-3 border-bottom pb-2 text-primary">Filtros de Búsqueda</h5>
                
                <form id="filtroVehiculosForm" method="GET">
                    <fieldset class="border-bottom mb-4 pb-3">
                        <legend class="fs-6 fw-bold text-secondary">Ciudad</legend>
                        <% opciones.ciudad.forEach(c => { %>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="filtroVehiculosConcesionario-<%= c %>" name="ciudad" value="<%= c %>"
                                <%= filtros.ciudad && filtros.ciudad.includes(c.toLowerCase()) ? 'checked' : '' %>>
                            <label class="form-check-label" for="filtroVehiculosColor-<%= c %>"><%= c %></label>
                        </div>
                        <% }) %>
                    </fieldset>
                    
                    <fieldset class="border-bottom mb-4 pb-3">
                        <legend class="fs-6 fw-bold text-secondary">Concesionario</legend>
                        <% opciones.concesionario.forEach(c => { %>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="filtroVehiculosConcesionario-<%= c.id_concesionario %>" name="concesionario"
                                value="<%= c.id_concesionario %>" <%= filtros.concesionario && filtros.concesionario.includes(c.id_concesionario) ? 'checked' : '' %>>
                            <label class="form-check-label" for="filtroVehiculosColor-<%= c.id_concesionario %>"><%= c.nombre %></label>
                        </div>
                        <% }) %>
                    </fieldset>
                    
                    <fieldset class="border-bottom mb-4 pb-3">
                        <legend class="fs-6 fw-bold text-secondary">Color</legend>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="filtroVehiculosColor-all" <%= filtros.color.length===0 ? 'checked' : '' %>>
                            <label class="form-check-label" for="filtroVehiculosColor-all">Todos</label>
                        </div>
                        <% opciones.color.forEach(c => { %>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input filtroVehiculosColor-option" id="filtroVehiculosColor-<%= c.replace(/\s+/g, '-') %>"
                                name="color" value="<%= c %>" <%= filtros.color && filtros.color.includes(c) ? 'checked' : '' %>>
                            <label class="form-check-label" for="filtroVehiculosColor-<%= c.replace(/\s+/g, '-') %>"><%= myUtils.capitalize(c) %></label>
                        </div>
                        <% }) %>
                    </fieldset>
                    
                    <fieldset class="border-bottom pb-3 mb-4">
                        <legend class="fs-6 fw-bold text-secondary">Número de plazas</legend>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="filtroVehiculosNumeroPlazas-all"
                                <%= filtros.numero_plazas.length===0 ? 'checked' : '' %>>
                            <label class="form-check-label" for="filtroVehiculosNumeroPlazas-all">Todos</label>
                        </div>
                        <% opciones.numero_plazas.forEach(p => { %>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input filtroVehiculosNumeroPlazas-option" id="filtroVehiculosNumeroPlazas-<%= p %>"
                                name="numero_plazas" value="<%= p %>" <%= filtros.numero_plazas && filtros.numero_plazas.includes(p) ? 'checked' : '' %>>
                            <label class="form-check-label" for="filtroVehiculosNumeroPlazas-<%= p %>"><%= p %></label>
                        </div>
                        <% }) %>
                    </fieldset>
                    
                    <fieldset class="border-bottom pb-3 mb-4">
                        <legend class="fs-6 fw-bold text-secondary">Autonomía mínima</legend>
                        <input type="range" class="form-range" min="0" max="1000" step="50"
                            value="<% if (!filtros.autonomia_km) { %>0<% } else { %><%= filtros.autonomia_km %><% } %>" id="filtroAutonomia" name="autonomia_km">
                        <div class="d-flex justify-content-between">
                             <small class="text-muted">Mínimo:</small>
                             <output for="filtroAutonomia" id="filtroAutonomiaValor" class="fw-bold"><% if (!filtros.autonomia_km) { %>0<% } else { %><%= filtros.autonomia_km %><% } %></output>
                        </div>
                    </fieldset>
                    
                    <fieldset>
                        <div class="g-1 row row-cols-1 row-cols-md-2">
                            <div class="col">
                                <button id="filtroVehiculosConfirm" class="btn btn-primary w-100" type="submit">Aplicar</button>
                            </div>
                            <div class="col">
                                <button class="btn btn-secondary w-100" type="reset" id="filtroVehiculosReset">Limpiar</button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>

        <div class="col-md-9">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                <% if (vehiculos.length===0) { %>
                <div class="col-12">
                    <h5 class="alert alert-info">No se han encontrado vehículos que coincidan con los filtros.</h5>
                </div>
                <% } %>
                <% vehiculos.forEach(v => { %>
                <div class="col">
                    <div class="card shadow card-hover h-100 rounded-3 border-3">
                        <div class="ratio ratio-16x9">
                            <img src="img/vehiculos/<%= v.imagen %>" class="card-img-top bg-light w-100 h-100 object-fit-contain" alt="<%= v.marca %> <%= v.modelo %>">
                        </div>
                        
                        <div class="p-3 border-bottom border-3">
                            <% let badgeClass = ''; 
                               if(v.estado==='disponible') badgeClass = 'text-bg-success'; 
                               else if(v.estado==='reservado') badgeClass='text-bg-danger';
                               else badgeClass='text-bg-warning'; %>
                            
                            <h5 class="card-title d-flex justify-content-between align-items-center mb-0">
                                <span class="fs-5 fw-bold text-dark"><%= v.marca %> <%= v.modelo %></span>
                                <span class="badge <%= badgeClass %>"><%= myUtils.capitalize(v.estado) %></span>
                            </h5>
                        </div>

                        <div class="card-body d-flex flex-column pt-3">
                            
                            <div class="card-text flex-grow-1">
                                <ul class="list-unstyled fw-normal">
                                    <li class="mb-1">
                                        <strong>Matrícula:</strong> <%= v.matricula %>
                                    </li>
                                    <li class="mb-1">
                                        <strong>Año:</strong> <%= v.anyo_matriculacion %>
                                    </li>
                                    <li class="mb-1">
                                        <strong>Plazas:</strong> <%= v.numero_plazas %>
                                    </li>
                                    <li class="mb-1">
                                        <strong>Autonomía:</strong> <%= v.autonomia_km %> km
                                    </li>
                                    <li class="mb-1">
                                        <strong>Color:</strong> <%= myUtils.capitalize(v.color) %>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card-footer text-center pb-3 border-top border-3">
                            <a href="/reservas/<%= v.id_vehiculo %>"
                                class="btn w-100 <%= v.id_concesionario !== user.concesionario.id_concesionario ? "btn-secondary disabled":"btn-primary" %>">
                                Reservar
                            </a>
                        </div>
                    </div>
                </div>
                <% }) %>
            </div>
        </div>
    </div>
</div>

<script src="/js/filtrarVehiculos.js"></script>